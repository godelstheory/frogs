---
title: "Giant Frogs in Bend"
author: 
  - "Corey Dow-Hygelund,  Mozilla"
  - "Tlell Wolf, Bend Science Station"
  - "Jay Bowerman, Sunriver Nature Center"
date: "1/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Loading

The dataset is contained in an Excel (.xlsx) spreadsheet, located in the subdirectory `data`. The raw statistics are on the sheet _All Female raw statistics_. Lets load it in and take a quick look.
```{r data_load, message=FALSE}
library(readxl)

file_path <- 'data/Female size statistics.2.xlsx'
data_df <- read_excel(file_path, range=(cell_cols('B:G')), 
                      sheet="All Females raw statistics")

head(data_df)
```

## Summary statistics

Before plotting, let's take a look at summary numbers. This helps ensure that the plots are being correctly rendered.

There are a total of `r nrow(data_df)` observations, for `r ncol(data_df)` sites. 


```{r summary}
summary(data_df)
```

Sunriver (SR) has significantly more observations than the other sites, with the second highest Dilman Meadows (DM) containing only half the measurements. This will influence plots based upon distributions.  

## Data Reshaping
The data is currently in the so-called _wide_ format, where each value of the site location variable is an independent column. Let's tranform it to the _long_ format, where each observation is contained in a single column, with another single column denoting site location.

In addition, there are many `NA` (NULL) values, due to the difference in number of observations across sites. These are easily removed with `na.omit`. 

```{r reshape}
library(tidyr)
data_long = na.omit(gather(data_df, site_location, size, 
                           CR:LSA, factor_key=FALSE))
head(data_long)
```

There are now `r nrow(data_long)` unique observations for _all_ sites.

## Plotting
In the following violin/boxplot, the order from left-right is either determined by a.) 1st observation/row in dataset, b.) the factor order. The desire is for the plot order to reflect the median frog size for readability. Therefore, we set the factor order accordingly.

```{r}
site_medians <- sort(apply(data_df, 2, median, na.rm=TRUE))
site_median_names <- names(site_medians)
site_max <- sort(apply(data_df, 2, max, na.rm=TRUE))
data_long$site_location <- factor(data_long$site_location, names(site_medians))
```

Also we retrieve the number of observation as a character vector to include in the plots
```{r}
num_obs <- as.character(table(data_long$site_location))
```

Finally we add an additional factor column for plotting counts in ridge plots: bona-fide hack.

```{r}
library(plyr)
data_long$site_loc_1 <- mapvalues(data_long$site_location, from=site_median_names, 
                                  paste(paste(levels(data_long$site_location), num_obs, sep='\n('), ')', sep =''))
data_long$site_loc_2 <- mapvalues(data_long$site_location, from=site_median_names, 
                                  paste(paste(levels(data_long$site_location), num_obs, sep=' ('), ')', sep =''))

```


### Optimal

#### Violin
If color isn't available, the violin/boxplot

```{r}
library(ggplot2)

violin_count_yloc <- site_max + c(5, 4, 10, 4, -4, 4) # Custom pretty offset

p <- ggplot(data_long, aes(x=site_location, y=size)) +
  labs(x = 'Location', y = 'Length (mm)') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold")) +  
  geom_violin() +
  geom_boxplot(width=0.1) +
  geom_text(data=data.frame(), aes(x=site_median_names, y=violin_count_yloc, label=num_obs))

p
```

#### Ridge
If we are fortunate enough for color, the ridge plot is a great choice.

The following has the counts below the labels
```{r, warning=FALSE, message=FALSE}
library(ggridges)

ggplot(data_long, aes(x=size, y=site_loc_1, fill=0.5 - abs(0.5-..ecdf..))) + 
  stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, to=max(data_long$size),
                      quantiles=c(0.05, 0.95), quantile_lines=TRUE) +
  scale_fill_viridis_c(name = "Tail probability", direction = -1, option = 'C') +
  # geom_text(x=site_median_names, y=site_location, label=num_obs) +
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold")) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))
```


The following has the counts inline with the labels
```{r, warning=FALSE, message=FALSE}

ggplot(data_long, aes(x=size, y=site_loc_2, fill=0.5 - abs(0.5-..ecdf..))) + 
  stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, to=max(data_long$size),
                      quantiles=c(0.05, 0.95), quantile_lines=TRUE) +
  scale_fill_viridis_c(name = "Tail probability", direction = -1, option = 'C') +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold")) 
```

### Violin/Boxplot

```{r violin_1}
library(ggplot2)

violin_count_yloc <- site_max + c(5, 4, 10, 4, -4, 4) # Custom pretty offset

p <- ggplot(data_long, aes(x=site_location, y=size)) +
  labs(x = 'Location', y = 'Length (mm)') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold"))
#   geom_violin(scale='count')
p +  geom_violin(draw_quantiles = c(0.5)) +
  geom_text(data=data.frame(), aes(x=site_median_names, y=violin_count_yloc, label=num_obs))

```

Standard boxplot 
```{r boxplot}
p + geom_boxplot() +
  geom_text(data=data.frame(), aes(x=site_median_names, y=violin_count_yloc, label=num_obs))
```


```{r boxplot_violin}
p +  
  geom_violin() +
  geom_boxplot(width=0.1) +
  geom_text(data=data.frame(), aes(x=site_median_names, y=violin_count_yloc, label=num_obs))
  
```

Producing the violin plot, where the violin area is scaled by the number of counts

```{r violin_2}
p +  
  geom_violin(scale='count') +
  geom_text(data=data.frame(), aes(x=site_median_names, y=violin_count_yloc, label=num_obs))

```

### Ridge

The ridge plot consists of the histograms being plotted one above the other. This enables direct comparison, in a manner that is intuitive.  

Histograms without converting to densities

```{r, warning=FALSE, message=FALSE}
ggplot(data_long, aes(x=size, y=site_location, height = ..density..)) + 
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold")) +
  geom_density_ridges(stat = "binline", bins = 20, scale = 0.95, draw_baseline = FALSE)

```


Converting to densities, which is easier on the eye.
```{r ridge_plot, warning=FALSE}
p <- ggplot(data_long, aes(x=size, y=site_location)) + 
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold"))
p + geom_density_ridges(to=max(data_long$size))
```

```{r, warning=FALSE}
p <- ggplot(data_long, aes(x=size, y=site_location)) + 
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold"))
p + geom_density_ridges(to=max(data_long$size))
```

Reducing the overlap between the histograms to zero.

```{r, warning=FALSE}
p + geom_density_ridges(scale = 1, to=max(data_long$size))
```

Adding in quantiles

```{r, warning=FALSE}
p + geom_density_ridges(scale = 1, quantile_lines=TRUE, quantiles=2, to=max(data_long$size))
```

#### Adding Color
Color representing probability of distribution. Dark represents the median (i.e. lower/upper 50%). Yellow represents the extreme tails. e.g. 0.1 represents 10% of the lower/upper distribution are contained. 

```{r, warning=FALSE}
ggplot(data_long, aes(x=size, y=site_location, fill=0.5 - abs(0.5-..ecdf..))) + 
  stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, to=max(data_long$size)) +
  scale_fill_viridis_c(name = "Tail probability", direction = -1) +
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold"))
```

Color representing length 
```{r, warning=FALSE, message=FALSE}
ggplot(data_long, aes(x=size, y=site_location, fill=..x..)) + 
  geom_density_ridges_gradient(to=max(data_long$size)) +
  scale_fill_viridis_c(name = "Length (mm)", option = "C")
  labs(x = 'Length (mm)', y = 'Location') +
  theme_classic() + 
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16,face="bold"))
 
```


